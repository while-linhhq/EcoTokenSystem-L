name: Deploy Frontend to AWS

on:
  push:
    branches:
      - master
    paths:
      - 'Frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:

env:
  # AWS Configuration
  AWS_REGION: us-east-1

  # S3 Configuration
  S3_BUCKET: ecotokensystem

  # CloudFront Configuration
  CLOUDFRONT_DISTRIBUTION_ID: E2O1UIN20NRIHM
  CLOUDFRONT_DOMAIN: d1j604m1z074dh.cloudfront.net

  # Backend API Configuration
  BACKEND_API_URL: https://d1j604m1z074dh.cloudfront.net/api

  # Node.js Configuration
  NODE_VERSION: '20'

  # Frontend Build Configuration
  FRONTEND_DIR: Frontend

jobs:
  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # CHECKOUT CODE
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # SETUP NODE.JS
      # ============================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      # ============================================
      # INSTALL DEPENDENCIES
      # ============================================
      - name: Install frontend dependencies
        working-directory: ./${{ env.FRONTEND_DIR }}
        run: |
          echo "Installing npm dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed"

      # ============================================
      # BUILD FRONTEND
      # ============================================
      - name: Build frontend
        working-directory: ./${{ env.FRONTEND_DIR }}
        env:
          VITE_API_BASE_URL: ${{ env.BACKEND_API_URL }}
        run: |
          echo "Building frontend with API URL: $VITE_API_BASE_URL"
          npm run build
          echo "‚úÖ Frontend build complete"

      - name: Verify build output
        working-directory: ./${{ env.FRONTEND_DIR }}
        run: |
          echo "Build output contents:"
          ls -lah dist/
          echo "‚úÖ Build verification complete"

      # ============================================
      # CONFIGURE AWS CREDENTIALS
      # ============================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ============================================
      # DEPLOY TO S3
      # ============================================
      - name: Sync static assets to S3 (with cache)
        working-directory: ./${{ env.FRONTEND_DIR }}
        run: |
          echo "Uploading static assets (JS, CSS, images) with long cache..."
          aws s3 sync dist/ s3://$S3_BUCKET \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"
          echo "‚úÖ Static assets uploaded"

      - name: Sync HTML and JSON files to S3 (no cache)
        working-directory: ./${{ env.FRONTEND_DIR }}
        run: |
          echo "Uploading HTML and JSON files with no cache..."
          aws s3 sync dist/ s3://$S3_BUCKET \
            --exclude "*" \
            --include "*.html" \
            --include "*.json" \
            --cache-control "no-cache, no-store, must-revalidate"
          echo "‚úÖ HTML/JSON files uploaded"

      # ============================================
      # INVALIDATE CLOUDFRONT CACHE
      # ============================================
      - name: Invalidate CloudFront cache
        run: |
          echo "Creating CloudFront invalidation..."
          INVALIDATION_OUTPUT=$(aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*" \
            --output json)

          INVALIDATION_ID=$(echo $INVALIDATION_OUTPUT | jq -r '.Invalidation.Id')
          echo "Invalidation ID: $INVALIDATION_ID"
          echo "Status: $(echo $INVALIDATION_OUTPUT | jq -r '.Invalidation.Status')"
          echo "‚úÖ CloudFront cache invalidation created"

      # ============================================
      # WAIT FOR INVALIDATION
      # ============================================
      - name: Wait for CloudFront invalidation
        run: |
          echo "Waiting for CloudFront invalidation to complete..."
          echo "Note: This may take 1-3 minutes"

          for i in {1..30}; do
            STATUS=$(aws cloudfront get-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --id $(aws cloudfront list-invalidations \
                --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
                --query 'InvalidationList.Items[0].Id' \
                --output text) \
              --query 'Invalidation.Status' \
              --output text)

            echo "Attempt $i: Invalidation status: $STATUS"

            if [ "$STATUS" = "Completed" ]; then
              echo "‚úÖ CloudFront invalidation completed!"
              break
            fi

            if [ $i -lt 30 ]; then
              sleep 6
            fi
          done

      # ============================================
      # VERIFY DEPLOYMENT
      # ============================================
      - name: Verify frontend deployment
        run: |
          echo "Verifying frontend is accessible..."
          FRONTEND_URL="https://${{ env.CLOUDFRONT_DOMAIN }}"

          sleep 5  # Wait a bit for CloudFront

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $FRONTEND_URL || echo "000")
          echo "Frontend returned HTTP $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Frontend is accessible!"
          else
            echo "‚ö†Ô∏è Warning: Frontend returned HTTP $HTTP_CODE"
            echo "This may be expected if CloudFront invalidation is still in progress"
          fi

      # ============================================
      # DEPLOYMENT SUMMARY
      # ============================================
      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Frontend deployment successful!"
          echo "===================================="
          echo "S3 Bucket: s3://${{ env.S3_BUCKET }}"
          echo "CloudFront Distribution: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "Frontend URL: https://${{ env.CLOUDFRONT_DOMAIN }}"
          echo "API Base URL: ${{ env.BACKEND_API_URL }}"
          echo "Git SHA: ${{ github.sha }}"
          echo "Git Ref: ${{ github.ref }}"
